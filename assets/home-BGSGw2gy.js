import{w as J}from"./with-props-7VRsLxky.js";import{o as t,a as M}from"./chunk-BAXFHI7N-CYWgGTUP.js";function K({displaySettings:e,setDisplaySettings:n}){return t.jsxs(t.Fragment,{children:[t.jsx("div",{children:t.jsxs("label",{className:"flex items-center cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.showMask,onChange:()=>n({...e,showMask:!e.showMask}),className:"mr-2"}),t.jsx("span",{children:"Show Obstacle Mask"})]})}),t.jsx("div",{children:t.jsxs("label",{className:"flex items-center cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.showVelocity,onChange:()=>n({...e,showVelocity:!e.showVelocity}),className:"mr-2"}),t.jsx("span",{children:"Show Velocity Field"})]})}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"vector-scale",className:"block mb-1",children:"Vector Scale:"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("input",{id:"vector-scale",type:"range",min:"0.1",max:"5",step:"0.1",value:e.vectorScale,onChange:d=>n({...e,vectorScale:parseFloat(d.target.value)}),className:"w-full"}),t.jsx("span",{className:"ml-2 w-12 text-right",children:e.vectorScale.toFixed(1)})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"grid-density",className:"block mb-1",children:"Display Grid Density:"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("input",{id:"grid-density",type:"range",min:"1",max:"32",step:"1",value:e.displayGridDensity,onChange:d=>n({...e,displayGridDensity:parseInt(d.target.value)}),className:"w-full"}),t.jsx("span",{className:"ml-2 w-8 text-right",children:e.displayGridDensity})]})]})]})}function Q({forces:e,onRemoveForce:n,onClearForces:d,onAddForce:h,onUpdateForce:l}){const c=i=>i.toFixed(3);return t.jsxs("div",{className:"mt-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx("h3",{className:"font-medium",children:"Force Vectors"}),t.jsxs("div",{className:"space-x-2",children:[h&&t.jsx("button",{onClick:h,className:"text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Add Force"}),e.length>0&&t.jsx("button",{onClick:d,className:"text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700",children:"Clear All"})]})]}),e.length===0?t.jsx("p",{className:"text-sm text-gray-500 italic",children:"Click and drag on the canvas to add force vectors."}):t.jsx("div",{className:"text-sm",children:t.jsxs("table",{className:"w-full border-collapse",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700",children:[t.jsx("th",{className:"p-2 text-left",children:"#"}),t.jsx("th",{className:"p-2 text-left",children:"Position"}),t.jsx("th",{className:"p-2 text-left",children:"Force"}),t.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),t.jsx("tbody",{children:e.map((i,a)=>t.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-700",children:[t.jsx("td",{className:"p-2",children:a+1}),t.jsx("td",{className:"p-2",children:l?t.jsxs("div",{className:"flex flex-col space-y-1",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-4",children:"x:"}),t.jsx("input",{type:"number",step:"0.1",min:"0",max:"1",value:i.x,onChange:o=>{const s=Math.max(0,Math.min(1,parseFloat(o.target.value)||0));l(a,{...i,x:s})},className:"w-16 ml-1 px-1 py-0 text-xs border rounded"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-4",children:"y:"}),t.jsx("input",{type:"number",step:"0.1",min:"0",max:"1",value:i.y,onChange:o=>{const s=Math.max(0,Math.min(1,parseFloat(o.target.value)||0));l(a,{...i,y:s})},className:"w-16 ml-1 px-1 py-0 text-xs border rounded"})]})]}):t.jsxs(t.Fragment,{children:["(",c(i.x),", ",c(i.y),")"]})}),t.jsx("td",{className:"p-2",children:l?t.jsxs("div",{className:"flex flex-col space-y-1",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-6",children:"fx:"}),t.jsx("input",{type:"number",step:"0.1",value:i.fx,onChange:o=>{const s=parseFloat(o.target.value)||0;l(a,{...i,fx:s})},className:"w-16 ml-1 px-1 py-0 text-xs border rounded"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-6",children:"fy:"}),t.jsx("input",{type:"number",step:"0.1",value:i.fy,onChange:o=>{const s=parseFloat(o.target.value)||0;l(a,{...i,fy:s})},className:"w-16 ml-1 px-1 py-0 text-xs border rounded"})]})]}):t.jsxs(t.Fragment,{children:["(",c(i.fx),", ",c(i.fy),")"]})}),t.jsx("td",{className:"p-2",children:t.jsx("button",{onClick:()=>n(a),className:"text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200",title:"Remove this force vector",children:"Ã—"})})]},`force-${a}`))})]})})]})}function Z({simulationGridConfig:e,setSimulationGridConfig:n,targetWeight:d,setTargetWeight:h}){return t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"grid-width",className:"block mb-1",children:"Grid Width:"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("input",{id:"grid-width",type:"range",min:"16",max:"128",step:"8",value:e.width,onChange:l=>n({...e,width:parseInt(l.target.value)}),className:"w-full"}),t.jsx("span",{className:"ml-2 w-8 text-right",children:e.width})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"grid-height",className:"block mb-1",children:"Grid Height:"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("input",{id:"grid-height",type:"range",min:"16",max:"128",step:"8",value:e.height,onChange:l=>n({...e,height:parseInt(l.target.value)}),className:"w-full"}),t.jsx("span",{className:"ml-2 w-8 text-right",children:e.height})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"target-weight",className:"block mb-1",children:"Target Velocity Weight:"}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("input",{id:"target-weight",type:"range",min:"0.01",max:"1.0",step:"0.01",value:d,onChange:l=>h(parseFloat(l.target.value)),className:"w-full"}),t.jsx("span",{className:"ml-2 w-12 text-right",children:d.toFixed(2)})]}),t.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Higher values (close to 1.0) enforce exact velocities, lower values (0.01-0.1) allow more natural flow."})]})]})}function ee({isSimulating:e,velocityField:n,obstacleMask:d,obstacleImageData:h,convergenceSteps:l,currentStep:c,currentDelta:i}){var a;return t.jsxs("div",{className:"mt-6",children:[t.jsx("p",{className:"font-medium",children:"Status"}),t.jsx("div",{className:"mt-1",children:e?t.jsxs("div",{children:[t.jsx("p",{className:"text-blue-600 dark:text-blue-400",children:"Running simulation..."}),t.jsxs("div",{className:"mt-2 space-y-1",children:[t.jsxs("p",{className:"text-sm",children:[t.jsx("span",{className:"font-semibold",children:"Current iteration:"})," ",c]}),i!==null&&t.jsxs("p",{className:"text-sm",children:[t.jsx("span",{className:"font-semibold",children:"Current delta:"})," ",i.toExponential(4)]})]})]}):n?t.jsxs("div",{children:[t.jsx("p",{className:"text-green-600 dark:text-green-400",children:"Simulation complete - Flow field generated"}),l!==null&&t.jsxs("p",{className:"text-sm mt-1",children:[t.jsx("span",{className:"font-semibold",children:"Steps until convergence:"})," ",l]})]}):d?t.jsxs("p",{className:"text-green-600 dark:text-green-400",children:["Obstacle mask generated (",d.length," x ",((a=d[0])==null?void 0:a.length)||0,")"]}):h?t.jsx("p",{children:"Processing image..."}):t.jsx("p",{className:"text-gray-500",children:"No obstacle image loaded"})}),t.jsxs("div",{className:"mt-4 p-2 bg-blue-50 dark:bg-blue-900/30 rounded-md",children:[t.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 font-medium",children:"Using Target Velocity Mode"}),t.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:"Vectors now control the target fluid velocity directly, rather than applying forces. Adjust the Target Velocity Weight to control how strongly these targets are enforced."})]})]})}function te({obstacleMask:e,obstacleImageData:n,simulationGridConfig:d,setSimulationGridConfig:h,displaySettings:l,setDisplaySettings:c,forceVectors:i,setForceVectors:a,targetWeight:o,setTargetWeight:s,isSimulating:r,velocityField:x,convergenceSteps:g,currentStep:v,currentDelta:b}){return t.jsxs("div",{className:"md:w-1/3 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md",children:[t.jsx("h2",{className:"text-xl font-semibold mb-3",children:"Controls"}),t.jsx("p",{className:"mb-4",children:"Drag and drop a PNG image onto the canvas to define an obstacle."}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h3",{className:"font-medium mb-2",children:"Simulation Settings"}),t.jsxs("div",{className:"space-y-4 text-sm",children:[t.jsx(Z,{simulationGridConfig:d,setSimulationGridConfig:h,targetWeight:o,setTargetWeight:s}),t.jsx(K,{displaySettings:l,setDisplaySettings:c}),t.jsx(ee,{isSimulating:r,velocityField:x,obstacleMask:e,obstacleImageData:n,convergenceSteps:g,currentStep:v,currentDelta:b}),t.jsx(Q,{forces:i,onRemoveForce:p=>{a(k=>k.filter((f,S)=>S!==p))},onClearForces:()=>a([]),onAddForce:()=>{const p={x:.2,y:.5,fx:.5,fy:0};a(k=>[...k,p])},onUpdateForce:(p,k)=>{a(f=>{const S=[...f];return S[p]=k,S})}}),t.jsxs("div",{className:"mt-6",children:[t.jsx("button",{onClick:()=>{e&&i.length>0&&a([...i])},disabled:!e||r||i.length===0,className:`px-4 py-2 rounded-md font-medium text-lg ${!e||r||i.length===0?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 shadow-md"}`,children:r?t.jsxs("span",{className:"flex items-center",children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Simulating..."]}):"Run Simulation"}),t.jsx("p",{className:"text-xs text-gray-600 mt-2",children:i.length===0?"Add target velocity vectors by clicking and dragging on the canvas":`${i.length} target velocity vector(s) added`})]})]})]})]})}function se(e,n,d,h,l="rgba(0, 0, 0, 0.7)"){if(!n.length||!n[0].length)return;const c=d/n[0].length,i=h/n.length;e.fillStyle=l;for(let a=0;a<n.length;a++)for(let o=0;o<n[0].length;o++)n[a][o]&&e.fillRect(o*c,a*i,c,i);e.strokeStyle="rgba(150, 150, 150, 0.5)",e.lineWidth=.5;for(let a=0;a<=n[0].length;a++)e.beginPath(),e.moveTo(a*c,0),e.lineTo(a*c,h),e.stroke();for(let a=0;a<=n.length;a++)e.beginPath(),e.moveTo(0,a*i),e.lineTo(d,a*i),e.stroke()}function ne(e,n,d,h,l,c=1){if(!n.u.length||!n.u[0].length)return;const{u:i,v:a}=n,o=i.length,s=i[0].length,r=h/s,x=l/o;e.strokeStyle="rgba(0, 100, 255, 0.7)",e.fillStyle="rgba(0, 100, 255, 0.7)",e.lineWidth=1;for(let g=0;g<o;g+=d)for(let v=0;v<s;v+=d){const b=i[g][v],p=a[g][v];if(Math.sqrt(b*b+p*p)<.001)continue;const f=v*r+r/2,S=g*x+x/2,w=b/s,O=p/o;if(Math.sqrt(w*w+O*O)<1e-5)continue;const T=f+w*h*c,R=S+O*l*c;e.beginPath(),e.moveTo(f,S),e.lineTo(T,R),e.stroke();const A=3,j=Math.atan2(O,w);e.beginPath(),e.moveTo(T,R),e.lineTo(T-A*Math.cos(j-Math.PI/6),R-A*Math.sin(j-Math.PI/6)),e.lineTo(T-A*Math.cos(j+Math.PI/6),R-A*Math.sin(j+Math.PI/6)),e.closePath(),e.fill()}}function le({width:e,height:n,className:d,onImageLoad:h,obstacleMask:l=null,showMask:c=!1,velocityField:i=null,vectorScale:a=1,displayGridDensity:o=16,onAddForce:s,forceVectors:r=[],showVelocity:x=!0}){const g=M.useRef(null),[v,b]=M.useState(!1),[p,k]=M.useState(null),[f,S]=M.useState(!1),[w,O]=M.useState(null),[P,T]=M.useState(null),R=F=>{F.preventDefault(),b(!0)},A=()=>{b(!1)},j=F=>{if(!l)return;const u=g.current;if(!u)return;const m=u.getBoundingClientRect(),C=(F.clientX-m.left)/e,N=(F.clientY-m.top)/n;S(!0),O({x:C,y:N}),T({x:C,y:N})},V=F=>{if(!f||!w)return;const u=g.current;if(!u)return;const m=u.getBoundingClientRect(),C=(F.clientX-m.left)/e,N=(F.clientY-m.top)/n;T({x:C,y:N})},G=F=>{if(!f||!w||!s)return;const u=g.current;if(!u)return;const m=u.getBoundingClientRect(),C=(F.clientX-m.left)/e,N=(F.clientY-m.top)/n,y=C-w.x,I=N-w.y;s({x:w.x,y:w.y,fx:y,fy:I}),S(!1),O(null),T(null)},U=()=>{f&&(S(!1),O(null),T(null))},_=F=>{F.preventDefault(),b(!1);const u=F.dataTransfer.files;if(u.length===0)return;const m=u[0];if(!m.type.startsWith("image/")){alert("Please drop an image file");return}const C=new FileReader;C.onload=N=>{var I;if(!((I=N.target)!=null&&I.result))return;const y=new Image;y.onload=()=>{k(y);const D=document.createElement("canvas");D.width=y.width,D.height=y.height;const X=D.getContext("2d");if(X){X.drawImage(y,0,0);const B=X.getImageData(0,0,y.width,y.height),$=800,q=600,W=y.width/y.height;let E,Y;W>=1?(E=Math.min($,y.width),Y=E/W):(Y=Math.min(q,y.height),E=Y*W),E=Math.round(E),Y=Math.round(Y),h&&h(B,{width:E,height:Y})}},y.src=N.target.result},C.readAsDataURL(m)};return M.useEffect(()=>{const F=g.current;if(!F)return;const u=F.getContext("2d");if(u){if(u.clearRect(0,0,e,n),p&&(!c||!l)){const m=Math.min(e/p.width,n/p.height),C=p.width*m,N=p.height*m,y=(e-C)/2,I=(n-N)/2;u.drawImage(p,y,I,C,N)}if(c&&l&&l.length>0&&se(u,l,e,n),!p&&!l){u.strokeStyle="#888",u.lineWidth=.5;for(let m=0;m<=e;m+=20)u.beginPath(),u.moveTo(m,0),u.lineTo(m,n),u.stroke();for(let m=0;m<=n;m+=20)u.beginPath(),u.moveTo(0,m),u.lineTo(e,m),u.stroke();u.fillStyle="#888",u.font="14px sans-serif",u.textAlign="center",u.fillText("Drag & drop an image here",e/2,n/2)}if(x&&i&&i.u.length>0&&i.v.length>0&&ne(u,i,o,e,n,a),r&&r.length>0){u.strokeStyle="rgba(255, 0, 0, 0.7)",u.lineWidth=2;for(const m of r){const C=m.x*e,N=m.y*n,y=C+m.fx*e,I=N+m.fy*n;u.beginPath(),u.moveTo(C,N),u.lineTo(y,I),u.stroke();const D=10,X=Math.atan2(m.fy,m.fx);u.fillStyle="rgba(255, 0, 0, 0.7)",u.beginPath(),u.moveTo(y,I),u.lineTo(y-D*Math.cos(X-Math.PI/6),I-D*Math.sin(X-Math.PI/6)),u.lineTo(y-D*Math.cos(X+Math.PI/6),I-D*Math.sin(X+Math.PI/6)),u.closePath(),u.fill(),u.fillStyle="rgba(255, 0, 0, 0.7)",u.beginPath(),u.arc(C,N,4,0,Math.PI*2),u.fill()}}if(f&&w&&P){const m=w.x*e,C=w.y*n,N=P.x*e,y=P.y*n;u.strokeStyle="rgba(255, 0, 0, 0.8)",u.lineWidth=2,u.beginPath(),u.moveTo(m,C),u.lineTo(N,y),u.stroke();const I=10,D=Math.atan2(y-C,N-m);u.fillStyle="rgba(255, 0, 0, 0.8)",u.beginPath(),u.moveTo(N,y),u.lineTo(N-I*Math.cos(D-Math.PI/6),y-I*Math.sin(D-Math.PI/6)),u.lineTo(N-I*Math.cos(D+Math.PI/6),y-I*Math.sin(D+Math.PI/6)),u.closePath(),u.fill(),u.fillStyle="rgba(255, 0, 0, 0.8)",u.beginPath(),u.arc(m,C,4,0,Math.PI*2),u.fill()}}},[e,n,l,c,i,a,o,f,w,P,p,r,x]),t.jsx("canvas",{ref:g,width:e,height:n,className:`border border-gray-300 bg-white dark:bg-gray-700 ${v?"border-blue-500 border-2":""} ${d||""}`,onDragOver:R,onDragLeave:A,onDrop:_,onMouseDown:j,onMouseMove:V,onMouseUp:G,onMouseLeave:U,style:{cursor:l?"crosshair":"default"}})}function L(e,n){return{width:e,height:n,pressure:Array(n).fill(0).map(()=>Array(e).fill(0)),u:Array(n).fill(0).map(()=>Array(e).fill(0)),v:Array(n).fill(0).map(()=>Array(e).fill(0)),isObstacle:Array(n).fill(0).map(()=>Array(e).fill(!1))}}function ae(e){if(e.length===0||e[0].length===0)throw new Error("Obstacle mask cannot be empty");const n=e.length,d=e[0].length,h=L(d,n);for(let l=0;l<n;l++)for(let c=0;c<d;c++)h.isObstacle[l][c]=e[l][c];return h}function re(e){const{width:n,height:d}=e,h=L(n,d);for(let l=0;l<d;l++)for(let c=0;c<n;c++)h.pressure[l][c]=e.pressure[l][c],h.u[l][c]=e.u[l][c],h.v[l][c]=e.v[l][c],h.isObstacle[l][c]=e.isObstacle[l][c];return h}function oe(e,n=.1){return e.map(d=>({x:d.x,y:d.y,u:d.fx,v:d.fy,weight:n}))}function z(e,n){return Array(n).fill(0).map(()=>Array(e).fill(0))}function H(e,n,d,h,l){const c=Math.max(.5,Math.min(h-1.5,n)),i=Math.max(.5,Math.min(l-1.5,d)),a=Math.floor(c),o=Math.floor(i),s=a+1,r=o+1,x=c-a,g=i-o,v=e[o][a],b=e[o][s],p=e[r][a],k=e[r][s],f=v*(1-x)+b*x,S=p*(1-x)+k*x;return f*(1-g)+S*g}const ie={relaxationFactor:.2,pressureImpact:.1,timeStep:.1,viscosity:.01,iterations:20};function ce(e,n,d=[],h=ie){const{relaxationFactor:l,pressureImpact:c,timeStep:i,viscosity:a}=h,o=re(e);return de(o,n),me(o,i),xe(o,a),he(o,l),ue(o,c),ge(o,d),fe(o),o}function de(e,n){const{width:d,height:h,u:l,v:c,isObstacle:i}=e;for(const a of n){const o=Math.floor(a.x*d),s=Math.floor(a.y*h);if(o<0||o>=d||s<0||s>=h||i[s][o])continue;const r=a.fx*d,x=a.fy*h;l[s][o]+=r,c[s][o]+=x}}function he(e,n){const{width:d,height:h,pressure:l,u:c,v:i,isObstacle:a}=e;for(let o=1;o<h-1;o++)for(let s=1;s<d-1;s++){if(a[o][s])continue;const r=c[o][s+1]-c[o][s-1]+i[o+1][s]-i[o-1][s];l[o][s]-=n*r}}function ue(e,n){const{width:d,height:h,pressure:l,u:c,v:i,isObstacle:a}=e;for(let o=1;o<h-1;o++)for(let s=1;s<d-1;s++){if(a[o][s])continue;const r=l[o][s+1]-l[o][s-1],x=l[o+1][s]-l[o-1][s];c[o][s]-=n*r,i[o][s]-=n*x}}function me(e,n){const{width:d,height:h,u:l,v:c,isObstacle:i}=e,a=z(d,h),o=z(d,h);for(let s=1;s<h-1;s++)for(let r=1;r<d-1;r++)if(!i[s][r]){const x=r-l[s][r]*n,g=s-c[s][r]*n;a[s][r]=H(l,x,g,d,h),o[s][r]=H(c,x,g,d,h)}for(let s=1;s<h-1;s++)for(let r=1;r<d-1;r++)i[s][r]||(l[s][r]=a[s][r],c[s][r]=o[s][r])}function xe(e,n){const{width:d,height:h,u:l,v:c,isObstacle:i}=e;if(n<1e-6)return;const a=z(d,h),o=z(d,h);for(let s=1;s<h-1;s++)for(let r=1;r<d-1;r++)if(!i[s][r]){const x=l[s][r+1]+l[s][r-1]+l[s+1][r]+l[s-1][r]-4*l[s][r],g=c[s][r+1]+c[s][r-1]+c[s+1][r]+c[s-1][r]-4*c[s][r];a[s][r]=l[s][r]+n*x,o[s][r]=c[s][r]+n*g}for(let s=1;s<h-1;s++)for(let r=1;r<d-1;r++)i[s][r]||(l[s][r]=a[s][r],c[s][r]=o[s][r])}function fe(e){const{width:n,height:d,u:h,v:l,isObstacle:c}=e;for(let i=0;i<d;i++)for(let a=0;a<n;a++)(c[i][a]||a===0||a===n-1||i===0||i===d-1)&&(h[i][a]=0,l[i][a]=0)}function ge(e,n){const{width:d,height:h,u:l,v:c,isObstacle:i}=e;for(const a of n){const o=Math.floor(a.x*d),s=Math.floor(a.y*h);if(o<1||o>=d-1||s<1||s>=h-1||i[s][o])continue;const r=a.u*d,x=a.v*h;l[s][o]=(1-a.weight)*l[s][o]+a.weight*r,c[s][o]=(1-a.weight)*c[s][o]+a.weight*x}}function pe({obstacleMask:e,forceVectors:n,targetWeight:d}){const[h,l]=M.useState(null),[c,i]=M.useState(!1),[a,o]=M.useState(null),[s,r]=M.useState(0),[x,g]=M.useState(null),v=M.useRef(null);return M.useEffect(()=>{if(!e)return;v.current&&v.current.abort();const b=new AbortController;v.current=b,i(!0),o(null),r(0),g(null);const p=ae(e);return(async()=>{if(b.signal.aborted){i(!1);return}let f=p,S=null,w=0;const O=5e3;let P=!1;const T=1e-4,R=oe(n,d);try{for(;w<O&&!P&&!b.signal.aborted;){await new Promise(j=>setTimeout(j,0)),f=ce(f,[],R),w++,r(w);let A=0;if(S){for(let j=0;j<f.u.length;j++)for(let V=0;V<f.u[j].length;V++){const G=Math.abs(f.u[j][V]-S.u[j][V]);A=Math.max(A,G)}for(let j=0;j<f.v.length;j++)for(let V=0;V<f.v[j].length;V++){const G=Math.abs(f.v[j][V]-S.v[j][V]);A=Math.max(A,G)}if(g(A),P=A<T,P)break}S={u:f.u.map(j=>[...j]),v:f.v.map(j=>[...j])},b.signal.aborted||l({u:f.u,v:f.v})}b.signal.aborted||(l({u:f.u,v:f.v}),o(P?w:null))}catch(A){console.error("Simulation error or aborted:",A)}finally{v.current===b&&i(!1)}})(),()=>{b.abort()}},[e,n,d]),[{velocityField:h,isSimulating:c,convergenceSteps:a,currentStep:s,currentDelta:x},{abortSimulation:()=>{v.current&&v.current.abort()}}]}function ye(e,n,d){const h=Array(d).fill(null).map(()=>Array(n).fill(!1)),l=e.width/n,c=e.height/d;let i=!1,a=!1;const o=Math.min(1e3,e.data.length/4);for(let s=0;s<o;s++){const r=s*4;if(e.data[r+3]<255&&(i=!0),(e.data[r]+e.data[r+1]+e.data[r+2])/3<240&&(a=!0),i&&a)break}for(let s=0;s<d;s++)for(let r=0;r<n;r++){const x=Math.floor(r*l),v=(Math.floor(s*c)*e.width+x)*4;if(i){const b=e.data[v+3];h[s][r]=b>128}else{const b=e.data[v],p=e.data[v+1],k=e.data[v+2],f=(b+p+k)/3;h[s][r]=f<128}}return h}function je({}){return[{title:"Steady-State Flow Utility"},{name:"description",content:"Interactive 2D steady-state fluid flow visualization"}]}const we=J(function(){const[n,d]=M.useState({width:600,height:400}),[h,l]=M.useState({width:64,height:64}),[c,i]=M.useState(null),[a,o]=M.useState(null),[s,r]=M.useState([]),[x,g]=M.useState({showMask:!1,vectorScale:1,displayGridDensity:8,showVelocity:!0}),[v,b]=M.useState(.1),[{velocityField:p,isSimulating:k,convergenceSteps:f,currentStep:S,currentDelta:w},{abortSimulation:O}]=pe({obstacleMask:a,forceVectors:s,targetWeight:v});return M.useEffect(()=>{if(c){const P=ye(c,h.width,h.height);o(P)}},[c,h.width,h.height]),t.jsxs("main",{className:"min-h-screen p-4",children:[t.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Steady-State Flow Utility"}),t.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[t.jsx("div",{className:"flex-1",children:t.jsx("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md",children:t.jsx(le,{width:n.width,height:n.height,onImageLoad:(P,T)=>{i(P),T&&d(T)},obstacleMask:a,showMask:x.showMask,velocityField:p,vectorScale:x.vectorScale,displayGridDensity:x.displayGridDensity,showVelocity:x.showVelocity,onAddForce:P=>{r(T=>[...T,P])},forceVectors:s})})}),t.jsx(te,{obstacleMask:a,obstacleImageData:c,simulationGridConfig:h,setSimulationGridConfig:l,displaySettings:x,setDisplaySettings:g,forceVectors:s,setForceVectors:r,targetWeight:v,setTargetWeight:b,isSimulating:k,velocityField:p,convergenceSteps:f,currentStep:S,currentDelta:w})]})]})});export{we as default,je as meta};
